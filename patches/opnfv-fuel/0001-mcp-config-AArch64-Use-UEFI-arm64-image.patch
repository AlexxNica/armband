From: Alexandru Avadanii <Alexandru.Avadanii@enea.com>
Date: Tue, 11 Jul 2017 18:24:24 +0200
Subject: [PATCH] mcp/config: AArch64: Use UEFI arm64 image

Also, allow removal of VMs booted via guest UEFI (OVMF or AAVMF).
While at it, bump default vCPU number from 2 to 6.

Signed-off-by: Guillermo Herrero <Guillermo.Herrero@enea.com>
Signed-off-by: Alexandru Avadanii <Alexandru.Avadanii@enea.com>
---
 mcp/config/defaults.yaml | 4 ++--
 mcp/scripts/lib.sh       | 4 ++--
 2 files changed, 4 insertions(+), 4 deletions(-)

diff --git a/mcp/config/defaults.yaml b/mcp/config/defaults.yaml
index b841e88..17fbbfc 100644
--- a/mcp/config/defaults.yaml
+++ b/mcp/config/defaults.yaml
@@ -1,6 +1,6 @@
-base_image: https://cloud-images.ubuntu.com/xenial/current/xenial-server-cloudimg-amd64-disk1.img
+base_image: https://cloud-images.ubuntu.com/xenial/current/xenial-server-cloudimg-arm64-uefi1.img
 virtual:
   default:
-    vcpus: 2
+    vcpus: 6
     ram: 4096

diff --git a/mcp/scripts/lib.sh b/mcp/scripts/lib.sh
index b3abd21..b2998e0 100644
--- a/mcp/scripts/lib.sh
+++ b/mcp/scripts/lib.sh
@@ -18,7 +18,7 @@ cleanup_vms() {
   # clean up existing nodes
   for node in $(virsh list --name | grep -P '\w{3}\d{2}'); do
     virsh destroy $node
-    virsh undefine $node
+    virsh undefine --nvram $node
   done
 }

@@ -57,7 +57,7 @@ create_vms() {

   # create vms with specified options
   for node in "${vnodes[@]}"; do
-    virt-install --name ${node} --ram ${vnodes_ram[$node]} --vcpus=2 --cpu host --accelerate \
+    virt-install --name ${node} --ram ${vnodes_ram[$node]} --vcpus=6 --cpu host --accelerate \
     --network network:pxe,model=virtio \
     --network network:mgmt,model=virtio \
     --network network:internal,model=virtio \
