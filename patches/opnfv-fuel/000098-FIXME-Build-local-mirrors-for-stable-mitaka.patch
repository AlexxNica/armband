From: Michal Skalski <mskalski@mirantis.com>
Date: Wed, 8 Jun 2016 00:54:57 +0200
Subject: [PATCH] Build local mirrors for stable/mitaka

Still in verification.

Change-Id: I3128652aeb87cb2cfaa91ded1b8d9ebeeb70d33b
Signed-off-by: Michal Skalski <mskalski@mirantis.com>
---
 build/Makefile                                     |    4 ++
 build/bootstrap_admin_node.sh.patch                |   22 ++++++++++++
 build/f_isoroot/Makefile                           |    4 +-
 build/f_isoroot/f_odlpluginbuild/Makefile          |    1 +
 build/f_isoroot/f_repobuild/Makefile               |    2 +-
 .../f_isoroot/f_repobuild/fuel_bootstrap_cli.yaml  |   36 +++++++++++---------
 6 files changed, 50 insertions(+), 19 deletions(-)

diff --git a/build/Makefile b/build/Makefile
index fdfb239..956183c 100644
--- a/build/Makefile
+++ b/build/Makefile
@@ -24,6 +24,10 @@ export ISOCACHE = $(shell pwd)/$(shell basename $(ISOSRC))
 export PRODNO = "OPNFV_FUEL"
 export REVSTATE = "P0000"
 export USER ?= $(shell whoami)
+export BUILD_DATE = $(shell date --utc +%Y-%m-%d:%H:%M)
+export OPNFV_GIT_SHA = $(shell git rev-parse HEAD)
+# Store in /etc/fuel_build_id on fuel master
+export BUILD_ID := $(PRODNO)_$(BUILD_DATE)_$(OPNFV_GIT_SHA)
 
 ifdef BUILD_FUEL_PLUGINS
 $(warning Overriding plugin build selection to $(BUILD_FUEL_PLUGINS))
diff --git a/build/bootstrap_admin_node.sh.patch b/build/bootstrap_admin_node.sh.patch
index aeef3f7..e137b74 100644
--- a/build/bootstrap_admin_node.sh.patch
+++ b/build/bootstrap_admin_node.sh.patch
@@ -34,6 +34,28 @@
     # Give user 15 seconds to enter fuelmenu or else continue
     echo
 ***************
+*** 360,368 ****
+    fi
+  fi
+
+  # Enable online base MOS repos (security, updates) if we run an ISO installation
+! [ -f /etc/fuel_build_id ] && \
+!   yum-config-manager --enable mos${FUEL_RELEASE}-security mos${FUEL_RELEASE}-updates --save
+
+  if [ ! -f "${ASTUTE_YAML}" ]; then
+    echo ${fuelmenu_fail_message}
+--- 360,369 ----
+    fi
+  fi
+
++ # OPNFV: Disabled to speedup installation in offline env.
+  # Enable online base MOS repos (security, updates) if we run an ISO installation
+! #[ -f /etc/fuel_build_id ] && \
+! #  yum-config-manager --enable mos${FUEL_RELEASE}-security mos${FUEL_RELEASE}-updates --save
+
+  if [ ! -f "${ASTUTE_YAML}" ]; then
+    echo ${fuelmenu_fail_message}
+***************
 *** 374,382 ****
   [ ! -f /etc/fuel_build_id ] && \
     sed -i "s|127.0.0.1:8080/ubuntu/x86_64|mirror.fuel-infra.org/mos-repos/ubuntu/${FUEL_RELEASE}|g" "${ASTUTE_YAML}"
diff --git a/build/f_isoroot/Makefile b/build/f_isoroot/Makefile
index 17ebef3..ed54e70 100644
--- a/build/f_isoroot/Makefile
+++ b/build/f_isoroot/Makefile
@@ -23,10 +23,10 @@ export PLUGINS
 ifdef BUILD_FUEL_PLUGINS
 export BUILD_FUEL_PLUGINS
 #SUBDIRS = f_kscfg f_bootstrap f_isolinux f_repobuild $(BUILD_FUEL_PLUGINS)
-SUBDIRS = f_kscfg f_bootstrap f_isolinux $(BUILD_FUEL_PLUGINS)
+SUBDIRS = f_kscfg f_bootstrap f_isolinux f_repobuild $(BUILD_FUEL_PLUGINS)
 $(warning Overriding plugin build selection to $(BUILD_FUEL_PLUGINS))
 else
-SUBDIRS = f_kscfg f_bootstrap f_isolinux $(PLUGINS)
+SUBDIRS = f_kscfg f_bootstrap f_isolinux f_repobuild $(PLUGINS)
 endif
 SUBCLEAN = $(addsuffix .clean,$(SUBDIRS))
 
diff --git a/build/f_isoroot/f_odlpluginbuild/Makefile b/build/f_isoroot/f_odlpluginbuild/Makefile
index efea0f5..c5978de 100644
--- a/build/f_isoroot/f_odlpluginbuild/Makefile
+++ b/build/f_isoroot/f_odlpluginbuild/Makefile
@@ -18,6 +18,7 @@ all: .odlbuild
 clean:
 	@rm -f .odlbuild ../release/opnfv/opendaylight*.rpm opendaylight*.rpm
 	@rm -f $(BUILD_BASE)/gitinfo_odlplugin.txt gitinfo_odlplugin.txt
+	@rm -rf fuel-plugins
 
 .PHONY: release
 release:.odlbuild
diff --git a/build/f_isoroot/f_repobuild/Makefile b/build/f_isoroot/f_repobuild/Makefile
index e95dbf2..5277218 100644
--- a/build/f_isoroot/f_repobuild/Makefile
+++ b/build/f_isoroot/f_repobuild/Makefile
@@ -47,7 +47,7 @@ nailgun:
 
 .PHONY: clean
 clean:
-	@rm -rf ../release/opnfv/nailgun nailgun fuel-mirror
+	@rm -rf ../release/opnfv/nailgun nailgun fuel-mirror opnfv-config.yaml ubuntu.yaml
 
 .PHONY: release
 release:nailgun
diff --git a/build/f_isoroot/f_repobuild/fuel_bootstrap_cli.yaml b/build/f_isoroot/f_repobuild/fuel_bootstrap_cli.yaml
index aa12c45..d8fab97 100644
--- a/build/f_isoroot/f_repobuild/fuel_bootstrap_cli.yaml
+++ b/build/f_isoroot/f_repobuild/fuel_bootstrap_cli.yaml
@@ -1,33 +1,37 @@
 ---
   root_ssh_authorized_file: /root/.ssh/id_rsa.pub
   extend_kopts: "biosdevname=0 net.ifnames=1 debug ignore_loglevel log_buf_len=10M print_fatal_signals=1 LOGLEVEL=8"
+  ubuntu_release: trusty
   extra_dirs:
     - /usr/share/fuel_bootstrap_cli/files/trusty
   output_dir: /tmp/
   kernel_flavor: linux-image-generic-lts-trusty
   packages:
-    - vim
+    - fuel-agent
+    - hwloc
+    - hpsa-dkms
+    - i40e-dkms
+    - linux-firmware
+    - linux-firmware-nonfree
+    - linux-headers-generic
+    - live-boot
+    - live-boot-initramfs-tools
     - mc
-    - openssh-client
-    - openssh-server
-    - ntp
     - mcollective
+    - msmtp-mta
+    - multipath-tools
+    - multipath-tools-boot
     - nailgun-agent
     - nailgun-mcagents
     - network-checker
-    - fuel-agent
+    - ntp
+    - openssh-client
+    - openssh-server
+    - squashfs-tools
     - ubuntu-minimal
-    - live-boot
-    - live-boot-initramfs-tools
+    - vim
     - wget
-    - linux-firmware
-    - linux-firmware-nonfree
-    - linux-headers-generic
-    - hpsa-dkms
-    - i40e-dkms
     - xz-utils
-    - squashfs-tools
-    - msmtp-mta
   bootstrap_images_dir: /var/www/nailgun/bootstraps
   active_bootstrap_symlink: /var/www/nailgun/bootstraps/active_bootstrap
   flavor: ubuntu
@@ -56,8 +60,8 @@
       section: "main restricted"
       uri: "http://127.0.0.1:8080/ubuntu/x86_64"
       priority: 1050
-      suite: mos8.0
+      suite: mos9.0
       type: deb
-  skip_default_img_build: true
+  skip_default_img_build: false
   direct_repo_addresses:
     - "127.0.0.1"
