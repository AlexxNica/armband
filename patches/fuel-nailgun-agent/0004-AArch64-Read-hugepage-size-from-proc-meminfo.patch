::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
: Copyright (c) 2017 Enea AB and others.
:
: All rights reserved. This program and the accompanying materials
: are made available under the terms of the Apache License, Version 2.0
: which accompanies this distribution, and is available at
: http://www.apache.org/licenses/LICENSE-2.0
::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::::
From: Alexandru Avadanii <Alexandru.Avadanii@enea.com>
Date: Fri, 19 May 2017 20:38:01 +0200
Subject: [PATCH] AArch64: Read hugepage size from /proc/meminfo

This method should be arch-indepedent, provided /proc/meminfo
reports the correct information.

Signed-off-by: Alexandru Avadanii <Alexandru.Avadanii@enea.com>
---
 ...ch64-Read-hugepage-size-from-proc-meminfo.patch | 30 ++++++++++++++++++++++
 debian/patches/series                              |  1 +
 2 files changed, 31 insertions(+)
 create mode 100644 debian/patches/0004-AArch64-Read-hugepage-size-from-proc-meminfo.patch

diff --git a/debian/patches/0004-AArch64-Read-hugepage-size-from-proc-meminfo.patch b/debian/patches/0004-AArch64-Read-hugepage-size-from-proc-meminfo.patch
new file mode 100644
index 0000000..16d78b5
--- /dev/null
+++ b/debian/patches/0004-AArch64-Read-hugepage-size-from-proc-meminfo.patch
@@ -0,0 +1,30 @@
+From: Alexandru Avadanii <Alexandru.Avadanii@enea.com>
+Date: Sun, 15 Jan 2017 08:14:12 +0100
+Subject: [PATCH 3/4] AArch64: Read hugepage size from /proc/meminfo
+
+This method should be arch-indepedent, provided /proc/meminfo
+reports the correct information.
+
+Signed-off-by: Alexandru Avadanii <Alexandru.Avadanii@enea.com>
+---
+ agent | 7 +++++++
+ 1 file changed, 7 insertions(+)
+
+diff --git a/agent b/agent
+index c3f5d28..01c17fe 100755
+--- a/agent
++++ b/agent
+@@ -1379,6 +1379,13 @@ class NodeAgent
+   def supported_hugepages
+     return [2048, 1048576] if _get_detailed_cpuinfo['0'][:flags].include?('pdpe1gb')
+     return [2048] if _get_detailed_cpuinfo['0'][:flags].include?('pse')
++    # AArch64 does not expose CPU flags, but we can rely on /proc/meminfo
++    File.open('/proc/meminfo').each do |l|
++      case l.strip
++        when /Hugepagesize:\s+(\d+)\s+kB/
++          return [$1.to_i()]
++        end
++    end
+     []
+   end
+
diff --git a/debian/patches/series b/debian/patches/series
index fa57b98..93ef079 100644
--- a/debian/patches/series
+++ b/debian/patches/series
@@ -1,3 +1,4 @@
 0001-ohai-Support-reading-L1-info-from-ethtool.patch
 0002-Temporary-SR-IOV-Fix-VNICs-broken-filter.patch
 0003-AArch64-Add-CPU-details-detection.patch
+0004-AArch64-Read-hugepage-size-from-proc-meminfo.patch
